<html>

<head>
    <title>023 | Webcam + particles | J3D</title>

    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <link rel="stylesheet" href="../demo/common/common.css"/>
    <script type="text/javascript" src="../demo/common/common.js"></script>

    <script type="text/javascript" src="../build/j3d.js"></script>
    <script type="text/javascript" src="../ext/UserStream.js"></script>

    <script>

        var engine, ctex, post;
        var mx = 0, my = 0;
        var postshader;

        window.onload = function() {
            if (!checkWebGL())
                return;

            engine = new J3D.Engine();
            J3D.Loader.loadGLSL("shaders/WebcamParticle.glsl", setupScene);
        }

        function setupScene(p) {
            postshader = p;
            webcam = new UserStream(onUserStream);
        }

        function onUserStream() {
            ctex = new J3D.Texture(webcam.output);

            postshader.colorOffset = [0.0, 0.0, 0.0];

            post = new J3D.Postprocess(engine);
            post.filter = postshader;

            var resX = 320, resY = 240;
            var resMul = 0.6;

            resX *= resMul;
            resY *= resMul;

            var cd = [], ns = [];
            for (var i = 0; i < resX; i++) {
                for(var j = 0; j < resY; j++) {
                    cd.push((i / resX) * 2 - 1, (j / resY) * 2 - 1);
                    ns.push( (1.0 + Math.random()) / 10, (Math.random() * 2 - 1) * 32);
                }
            }

            post.geometry = new J3D.Geometry();
            post.geometry.addArray("aParticle", new Float32Array(cd), 2);
            post.geometry.addArray("aNormal", new Float32Array(ns), 2);
            post.drawMode = gl.POINTS;

            post.render = function() {
                J3D.Time.tick();
                ctex.update();
                this.renderEffect(ctex.tex);
            }

            document.onmousemove = onMouseMove;

            draw();
        }

        function onMouseMove(e) {
            mx = ( e.clientX / window.innerWidth * 2 ) - 1;
            my = ( e.clientY / window.innerHeight * 2 ) - 1;
        }

        function draw() {
            post.filter.colorOffset = [mx * -0.02, 0.0, mx * 0.02];
            post.filter.mousePos = [mx * 2, my * 2];
            post.render();
            requestAnimationFrame(draw);
        }

    </script>

</head>

<body>
<script>
    setLabels("023. Webcam + particles", "Works in Chrome with <a href='http://www.webrtc.org/running-the-demos'>MediaStream enabled</a> and in <a href='http://snapshot.opera.com/labs/camera/'>Opera Labs Camera</a>.");
</script>
</body>

</html> 











