<html> 
 
<head> 
<title>002 | Scene | J3D</title> 

<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"> 

<link rel="stylesheet" href="common/common.css"/>
<script type="text/javascript" src="common/common.js"></script>

<script type="text/javascript" src="../build/j3d.js"></script>

<script>
	var mx = 0, my = 0;
	var jsonScene;
	var root, camera, whiteMat;
	var rings = [];
	
	function init() {
		if(!checkWebGL()) return;

		engine = new J3D.Engine();
		
		J3D.Loader.loadJSON("models/text.json", function(jsmeshes) { 
			J3D.Loader.loadJSON("models/textScene.json", function(jsscene) { 
				jsonScene = jsscene;
				J3D.Loader.parseJSONScene(jsscene, jsmeshes, engine);
				
				root = engine.scene.find("root");
                camera = engine.scene.find("camera");

                j3dlog(camera.camera);

				rings[0] = engine.scene.find("root/ring");
				rings[1] = engine.scene.find("root/ring/ring");
				rings[2] = engine.scene.find("root/ring/ring/ring");
				rings[3] = engine.scene.find("root/ring/ring/ring/ring");
				rings[4] = engine.scene.find("root/ring/ring/ring/ring/ring");
				rings[5] = engine.scene.find("root/ring/ring/ring/ring/ring/ring");
				rings[6] = engine.scene.find("root/ring/ring/ring/ring/ring/ring/ring");

                rings[0].collider = J3D.Collider.Mesh(rings[0].geometry);
                rings[1].collider = J3D.Collider.Mesh(rings[1].geometry);
                rings[2].collider = J3D.Collider.Mesh(rings[2].geometry);
                rings[3].collider = J3D.Collider.Mesh(rings[3].geometry);
                rings[4].collider = J3D.Collider.Mesh(rings[4].geometry);
                rings[5].collider = J3D.Collider.Mesh(rings[5].geometry);
                rings[6].collider = J3D.Collider.Mesh(rings[6].geometry);

                rings[0].originalRenderer = rings[0].renderer;
                rings[1].originalRenderer = rings[1].renderer;
                rings[2].originalRenderer = rings[2].renderer;
                rings[3].originalRenderer = rings[3].renderer;
                rings[4].originalRenderer = rings[4].renderer;
                rings[5].originalRenderer = rings[5].renderer;
                rings[6].originalRenderer = rings[6].renderer;

				draw();
			})
		});

        whiteMat = J3D.BuiltinShaders.fetch("Phong");
		whiteMat.su.color = J3D.Color.white;

		document.onmousemove = onMouseMove;
	}
	
	function onMouseMove(e) {
		mx = e.clientX;
		my = e.clientY;
	}
	
	function draw() {
		var sx = (( mx / window.innerWidth  ) * 2 - 1) * J3D.Time.deltaTime / 1000;
		var sy = (( my / window.innerHeight ) * 2 - 1) * J3D.Time.deltaTime / 1000;

        var r = J3D.Ray.fromMousePosition(mx, my, camera);

        var rh0 = J3D.Intersection.rayMesh(r, rings[0]);
        var rh1 = J3D.Intersection.rayMesh(r, rings[1]);
        var rh2 = J3D.Intersection.rayMesh(r, rings[2]);
        var rh3 = J3D.Intersection.rayMesh(r, rings[3]);
        var rh4 = J3D.Intersection.rayMesh(r, rings[4]);
        var rh5 = J3D.Intersection.rayMesh(r, rings[5]);
        var rh6 = J3D.Intersection.rayMesh(r, rings[6]);

        rings[0].renderer = (rh0) ? whiteMat : rings[0].originalRenderer;
		rings[1].renderer = (rh1) ? whiteMat : rings[1].originalRenderer;
        rings[2].renderer = (rh2) ? whiteMat : rings[2].originalRenderer;
        rings[3].renderer = (rh3) ? whiteMat : rings[3].originalRenderer;
        rings[4].renderer = (rh4) ? whiteMat : rings[4].originalRenderer;
        rings[5].renderer = (rh5) ? whiteMat : rings[5].originalRenderer;
        rings[6].renderer = (rh6) ? whiteMat : rings[6].originalRenderer;

        root.rotation.y += sx;

		rings[0].rotation.y += sx;
		rings[1].rotation.y -= sx * 0.1;
		rings[2].rotation.y -= sx * 0.12;
		rings[3].rotation.y -= sx * 0.14;
		rings[4].rotation.y -= sx * 0.16;
		rings[5].rotation.y -= sx * 0.18;
		rings[6].rotation.y -= sx * 0.2;

		rings[0].rotation.x += sy;
		rings[1].rotation.x -= sy * 0.1;
		rings[2].rotation.x -= sy * 0.12;
		rings[3].rotation.x -= sy * 0.14;
		rings[4].rotation.x -= sy * 0.16;
		rings[5].rotation.x -= sy * 0.18;
		rings[6].rotation.x -= sy * 0.2;
		
		engine.render();
        requestAnimationFrame(draw);
	}
		
</script>

</head> 

<body onload="init();">
	<script>
		setLabels("002. Unity3d scene", "A simple scene with lights, camera and meshes<br>exported from Unity3d");
	</script>
	
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24294554-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body> 

</html> 