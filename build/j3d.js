/*

J3D, a Javascript/WebGL 3D egnine
Created by Bartek Drozdz <bartek@everydayflash.com>
http://www.everyday3d.com/j3d/ 

Uses the following libraries:

glMatrix, Copyright (c) 2010 Brandon Jone
http://code.google.com/p/glmatrix/

requestAnimationFrame
http://paulirish.com/2011/requestanimationframe-for-smart-animating/

*/
// gl-matrix 1.2 - https://github.com/toji/gl-matrix/blob/master/LICENSE.md
(function(){var a="undefined"!=typeof exports?global:window;a.glMatrixArrayType=a.MatrixArray=null;a.vec3={};a.mat3={};a.mat4={};a.quat4={};a.setMatrixArrayType=function(a){return glMatrixArrayType=MatrixArray=a};a.determineMatrixArrayType=function(){return setMatrixArrayType("undefined"!==typeof Float32Array?Float32Array:Array)};determineMatrixArrayType()})();vec3.create=function(a){var b=new MatrixArray(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):b[0]=b[1]=b[2]=0;return b};
vec3.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b};vec3.add=function(a,b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c};vec3.subtract=function(a,b,c){if(!c||a===c)return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a;c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c};vec3.negate=function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b};
vec3.scale=function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c};vec3.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=Math.sqrt(c*c+d*d+e*e);if(g){if(1===g)return b[0]=c,b[1]=d,b[2]=e,b}else return b[0]=0,b[1]=0,b[2]=0,b;g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;return b};vec3.cross=function(a,b,c){c||(c=a);var d=a[0],e=a[1],a=a[2],g=b[0],f=b[1],b=b[2];c[0]=e*b-a*f;c[1]=a*g-d*b;c[2]=d*f-e*g;return c};
vec3.length=function(a){var b=a[0],c=a[1],a=a[2];return Math.sqrt(b*b+c*c+a*a)};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.direction=function(a,b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1],a=a[2]-b[2],b=Math.sqrt(d*d+e*e+a*a);if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/b;c[0]=d*b;c[1]=e*b;c[2]=a*b;return c};vec3.lerp=function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return d};
vec3.dist=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)};vec3.unproject=function(a,b,c,d,e){e||(e=a);var g=mat4.create(),f=new MatrixArray(4);f[0]=2*(a[0]-d[0])/d[2]-1;f[1]=2*(a[1]-d[1])/d[3]-1;f[2]=2*a[2]-1;f[3]=1;mat4.multiply(c,b,g);if(!mat4.inverse(g))return null;mat4.multiplyVec4(g,f);if(0===f[3])return null;e[0]=f[0]/f[3];e[1]=f[1]/f[3];e[2]=f[2]/f[3];return e};vec3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};
mat3.create=function(a){var b=new MatrixArray(9);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8]);return b};mat3.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b};mat3.identity=function(a){a||(a=mat3.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};
mat3.transpose=function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e;return a}b[0]=a[0];b[1]=a[3];b[2]=a[6];b[3]=a[1];b[4]=a[4];b[5]=a[7];b[6]=a[2];b[7]=a[5];b[8]=a[8];return b};mat3.toMat4=function(a,b){b||(b=mat4.create());b[15]=1;b[14]=0;b[13]=0;b[12]=0;b[11]=0;b[10]=a[8];b[9]=a[7];b[8]=a[6];b[7]=0;b[6]=a[5];b[5]=a[4];b[4]=a[3];b[3]=0;b[2]=a[2];b[1]=a[1];b[0]=a[0];return b};
mat3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"};mat4.create=function(a){var b=new MatrixArray(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b};
mat4.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b};mat4.identity=function(a){a||(a=mat4.create());a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};
mat4.transpose=function(a,b){if(!b||a===b){var c=a[1],d=a[2],e=a[3],g=a[6],f=a[7],h=a[11];a[1]=a[4];a[2]=a[8];a[3]=a[12];a[4]=c;a[6]=a[9];a[7]=a[13];a[8]=d;a[9]=g;a[11]=a[14];a[12]=e;a[13]=f;a[14]=h;return a}b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b};
mat4.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],g=a[4],f=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],n=a[11],o=a[12],m=a[13],p=a[14],a=a[15];return o*k*h*e-j*m*h*e-o*f*l*e+g*m*l*e+j*f*p*e-g*k*p*e-o*k*d*i+j*m*d*i+o*c*l*i-b*m*l*i-j*c*p*i+b*k*p*i+o*f*d*n-g*m*d*n-o*c*h*n+b*m*h*n+g*c*p*n-b*f*p*n-j*f*d*a+g*k*d*a+j*c*h*a-b*k*h*a-g*c*l*a+b*f*l*a};
mat4.inverse=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],n=a[10],o=a[11],m=a[12],p=a[13],r=a[14],s=a[15],A=c*h-d*f,B=c*i-e*f,t=c*j-g*f,u=d*i-e*h,v=d*j-g*h,w=e*j-g*i,x=k*p-l*m,y=k*r-n*m,z=k*s-o*m,C=l*r-n*p,D=l*s-o*p,E=n*s-o*r,q=A*E-B*D+t*C+u*z-v*y+w*x;if(!q)return null;q=1/q;b[0]=(h*E-i*D+j*C)*q;b[1]=(-d*E+e*D-g*C)*q;b[2]=(p*w-r*v+s*u)*q;b[3]=(-l*w+n*v-o*u)*q;b[4]=(-f*E+i*z-j*y)*q;b[5]=(c*E-e*z+g*y)*q;b[6]=(-m*w+r*t-s*B)*q;b[7]=(k*w-n*t+o*B)*q;b[8]=
(f*D-h*z+j*x)*q;b[9]=(-c*D+d*z-g*x)*q;b[10]=(m*v-p*t+s*A)*q;b[11]=(-k*v+l*t-o*A)*q;b[12]=(-f*C+h*y-i*x)*q;b[13]=(c*C-d*y+e*x)*q;b[14]=(-m*u+p*B-r*A)*q;b[15]=(k*u-l*B+n*A)*q;return b};mat4.toRotationMat=function(a,b){b||(b=mat4.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};
mat4.toMat3=function(a,b){b||(b=mat3.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[4];b[4]=a[5];b[5]=a[6];b[6]=a[8];b[7]=a[9];b[8]=a[10];return b};mat4.toInverseMat3=function(a,b){var c=a[0],d=a[1],e=a[2],g=a[4],f=a[5],h=a[6],i=a[8],j=a[9],k=a[10],l=k*f-h*j,n=-k*g+h*i,o=j*g-f*i,m=c*l+d*n+e*o;if(!m)return null;m=1/m;b||(b=mat3.create());b[0]=l*m;b[1]=(-k*d+e*j)*m;b[2]=(h*d-e*f)*m;b[3]=n*m;b[4]=(k*c-e*i)*m;b[5]=(-h*c+e*g)*m;b[6]=o*m;b[7]=(-j*c+d*i)*m;b[8]=(f*c-d*g)*m;return b};
mat4.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],n=a[9],o=a[10],m=a[11],p=a[12],r=a[13],s=a[14],a=a[15],A=b[0],B=b[1],t=b[2],u=b[3],v=b[4],w=b[5],x=b[6],y=b[7],z=b[8],C=b[9],D=b[10],E=b[11],q=b[12],F=b[13],G=b[14],b=b[15];c[0]=A*d+B*h+t*l+u*p;c[1]=A*e+B*i+t*n+u*r;c[2]=A*g+B*j+t*o+u*s;c[3]=A*f+B*k+t*m+u*a;c[4]=v*d+w*h+x*l+y*p;c[5]=v*e+w*i+x*n+y*r;c[6]=v*g+w*j+x*o+y*s;c[7]=v*f+w*k+x*m+y*a;c[8]=z*d+C*h+D*l+E*p;c[9]=z*e+C*i+D*n+E*r;c[10]=z*g+C*
j+D*o+E*s;c[11]=z*f+C*k+D*m+E*a;c[12]=q*d+F*h+G*l+b*p;c[13]=q*e+F*i+G*n+b*r;c[14]=q*g+F*j+G*o+b*s;c[15]=q*f+F*k+G*m+b*a;return c};mat4.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c};
mat4.multiplyVec4=function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2],b=b[3];c[0]=a[0]*d+a[4]*e+a[8]*g+a[12]*b;c[1]=a[1]*d+a[5]*e+a[9]*g+a[13]*b;c[2]=a[2]*d+a[6]*e+a[10]*g+a[14]*b;c[3]=a[3]*d+a[7]*e+a[11]*g+a[15]*b;return c};
mat4.translate=function(a,b,c){var d=b[0],e=b[1],b=b[2],g,f,h,i,j,k,l,n,o,m,p,r;if(!c||a===c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;g=a[0];f=a[1];h=a[2];i=a[3];j=a[4];k=a[5];l=a[6];n=a[7];o=a[8];m=a[9];p=a[10];r=a[11];c[0]=g;c[1]=f;c[2]=h;c[3]=i;c[4]=j;c[5]=k;c[6]=l;c[7]=n;c[8]=o;c[9]=m;c[10]=p;c[11]=r;c[12]=g*d+j*e+o*b+a[12];c[13]=f*d+k*e+m*b+a[13];c[14]=h*d+l*e+p*b+a[14];c[15]=i*d+n*e+r*b+a[15];
return c};mat4.scale=function(a,b,c){var d=b[0],e=b[1],b=b[2];if(!c||a===c)return a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,a;c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c};
mat4.rotate=function(a,b,c,d){var e=c[0],g=c[1],c=c[2],f=Math.sqrt(e*e+g*g+c*c),h,i,j,k,l,n,o,m,p,r,s,A,B,t,u,v,w,x,y,z;if(!f)return null;1!==f&&(f=1/f,e*=f,g*=f,c*=f);h=Math.sin(b);i=Math.cos(b);j=1-i;b=a[0];f=a[1];k=a[2];l=a[3];n=a[4];o=a[5];m=a[6];p=a[7];r=a[8];s=a[9];A=a[10];B=a[11];t=e*e*j+i;u=g*e*j+c*h;v=c*e*j-g*h;w=e*g*j-c*h;x=g*g*j+i;y=c*g*j+e*h;z=e*c*j+g*h;e=g*c*j-e*h;g=c*c*j+i;d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a;d[0]=b*t+n*u+r*v;d[1]=f*t+o*u+s*v;d[2]=k*t+m*u+A*
v;d[3]=l*t+p*u+B*v;d[4]=b*w+n*x+r*y;d[5]=f*w+o*x+s*y;d[6]=k*w+m*x+A*y;d[7]=l*w+p*x+B*y;d[8]=b*z+n*e+r*g;d[9]=f*z+o*e+s*g;d[10]=k*z+m*e+A*g;d[11]=l*z+p*e+B*g;return d};mat4.rotateX=function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[4],g=a[5],f=a[6],h=a[7],i=a[8],j=a[9],k=a[10],l=a[11];c?a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[4]=e*b+i*d;c[5]=g*b+j*d;c[6]=f*b+k*d;c[7]=h*b+l*d;c[8]=e*-d+i*b;c[9]=g*-d+j*b;c[10]=f*-d+k*b;c[11]=h*-d+l*b;return c};
mat4.rotateY=function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[0],g=a[1],f=a[2],h=a[3],i=a[8],j=a[9],k=a[10],l=a[11];c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+i*-d;c[1]=g*b+j*-d;c[2]=f*b+k*-d;c[3]=h*b+l*-d;c[8]=e*d+i*b;c[9]=g*d+j*b;c[10]=f*d+k*b;c[11]=h*d+l*b;return c};
mat4.rotateZ=function(a,b,c){var d=Math.sin(b),b=Math.cos(b),e=a[0],g=a[1],f=a[2],h=a[3],i=a[4],j=a[5],k=a[6],l=a[7];c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+i*d;c[1]=g*b+j*d;c[2]=f*b+k*d;c[3]=h*b+l*d;c[4]=e*-d+i*b;c[5]=g*-d+j*b;c[6]=f*-d+k*b;c[7]=h*-d+l*b;return c};
mat4.frustum=function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,i=d-c,j=g-e;f[0]=2*e/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2*e/i;f[6]=0;f[7]=0;f[8]=(b+a)/h;f[9]=(d+c)/i;f[10]=-(g+e)/j;f[11]=-1;f[12]=0;f[13]=0;f[14]=-(2*g*e)/j;f[15]=0;return f};mat4.perspective=function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b*=a;return mat4.frustum(-b,b,-a,a,c,d,e)};
mat4.ortho=function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,i=d-c,j=g-e;f[0]=2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/i;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/j;f[11]=0;f[12]=-(a+b)/h;f[13]=-(d+c)/i;f[14]=-(g+e)/j;f[15]=1;return f};
mat4.lookAt=function(a,b,c,d){d||(d=mat4.create());var e,g,f,h,i,j,k,l,n=a[0],o=a[1],a=a[2];g=c[0];f=c[1];e=c[2];c=b[1];j=b[2];if(n===b[0]&&o===c&&a===j)return mat4.identity(d);c=n-b[0];j=o-b[1];k=a-b[2];l=1/Math.sqrt(c*c+j*j+k*k);c*=l;j*=l;k*=l;b=f*k-e*j;e=e*c-g*k;g=g*j-f*c;(l=Math.sqrt(b*b+e*e+g*g))?(l=1/l,b*=l,e*=l,g*=l):g=e=b=0;f=j*g-k*e;h=k*b-c*g;i=c*e-j*b;(l=Math.sqrt(f*f+h*h+i*i))?(l=1/l,f*=l,h*=l,i*=l):i=h=f=0;d[0]=b;d[1]=f;d[2]=c;d[3]=0;d[4]=e;d[5]=h;d[6]=j;d[7]=0;d[8]=g;d[9]=i;d[10]=k;d[11]=
0;d[12]=-(b*n+e*o+g*a);d[13]=-(f*n+h*o+i*a);d[14]=-(c*n+j*o+k*a);d[15]=1;return d};mat4.fromRotationTranslation=function(a,b,c){c||(c=mat4.create());var d=a[0],e=a[1],g=a[2],f=a[3],h=d+d,i=e+e,j=g+g,a=d*h,k=d*i,d=d*j,l=e*i,e=e*j,g=g*j,h=f*h,i=f*i,f=f*j;c[0]=1-(l+g);c[1]=k+f;c[2]=d-i;c[3]=0;c[4]=k-f;c[5]=1-(a+g);c[6]=e+h;c[7]=0;c[8]=d+i;c[9]=e-h;c[10]=1-(a+l);c[11]=0;c[12]=b[0];c[13]=b[1];c[14]=b[2];c[15]=1;return c};
mat4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"};quat4.create=function(a){var b=new MatrixArray(4);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]);return b};quat4.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};
quat4.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];if(!b||a===b)return a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a;b[0]=c;b[1]=d;b[2]=e;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return b};quat4.inverse=function(a,b){if(!b||a===b)return a[0]*=-1,a[1]*=-1,a[2]*=-1,a;b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b};quat4.length=function(a){var b=a[0],c=a[1],d=a[2],a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)};
quat4.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=Math.sqrt(c*c+d*d+e*e+g*g);if(0===f)return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b;f=1/f;b[0]=c*f;b[1]=d*f;b[2]=e*f;b[3]=g*f;return b};quat4.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],a=a[3],f=b[0],h=b[1],i=b[2],b=b[3];c[0]=d*b+a*f+e*i-g*h;c[1]=e*b+a*h+g*f-d*i;c[2]=g*b+a*i+d*h-e*f;c[3]=a*b-d*f-e*h-g*i;return c};
quat4.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2],b=a[0],f=a[1],h=a[2],a=a[3],i=a*d+f*g-h*e,j=a*e+h*d-b*g,k=a*g+b*e-f*d,d=-b*d-f*e-h*g;c[0]=i*a+d*-b+j*-h-k*-f;c[1]=j*a+d*-f+k*-b-i*-h;c[2]=k*a+d*-h+i*-f-j*-b;return c};quat4.toMat3=function(a,b){b||(b=mat3.create());var c=a[0],d=a[1],e=a[2],g=a[3],f=c+c,h=d+d,i=e+e,j=c*f,k=c*h,c=c*i,l=d*h,d=d*i,e=e*i,f=g*f,h=g*h,g=g*i;b[0]=1-(l+e);b[1]=k+g;b[2]=c-h;b[3]=k-g;b[4]=1-(j+e);b[5]=d+f;b[6]=c+h;b[7]=d-f;b[8]=1-(j+l);return b};
quat4.toMat4=function(a,b){b||(b=mat4.create());var c=a[0],d=a[1],e=a[2],g=a[3],f=c+c,h=d+d,i=e+e,j=c*f,k=c*h,c=c*i,l=d*h,d=d*i,e=e*i,f=g*f,h=g*h,g=g*i;b[0]=1-(l+e);b[1]=k+g;b[2]=c-h;b[3]=0;b[4]=k-g;b[5]=1-(j+e);b[6]=d+f;b[7]=0;b[8]=c+h;b[9]=d-f;b[10]=1-(j+l);b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};
quat4.slerp=function(a,b,c,d){d||(d=a);var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3],g,f;if(1<=Math.abs(e))return d!==a&&(d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=a[3]),d;g=Math.acos(e);f=Math.sqrt(1-e*e);if(0.001>Math.abs(f))return d[0]=0.5*a[0]+0.5*b[0],d[1]=0.5*a[1]+0.5*b[1],d[2]=0.5*a[2]+0.5*b[2],d[3]=0.5*a[3]+0.5*b[3],d;e=Math.sin((1-c)*g)/f;c=Math.sin(c*g)/f;d[0]=a[0]*e+b[0]*c;d[1]=a[1]*e+b[1]*c;d[2]=a[2]*e+b[2]*c;d[3]=a[3]*e+b[3]*c;return d};
quat4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};j3dlogIds={};function j3dlog(a){J3D.debug&&console.log(a)}function j3dlogOnce(a){J3D.debug&&j3dlogIds[a]==null&&console.log(a);j3dlogIds[a]=!0};J3D={};J3D.debug=!0;J3D.LightmapAtlas=[];J3D.SHADER_MAX_LIGHTS=4;J3D.RENDER_AS_OPAQUE=0;J3D.RENDER_AS_TRANSPARENT=1;var v3=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};v3.prototype.set=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};v3.prototype.fromArray=function(a){this.x=a[0];this.y=a[1];this.z=a[2]};v3.prototype.magSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};v3.prototype.mag=function(){return Math.sqrt(this.magSq())};v3.prototype.mul=function(a){return new v3(this.x*a,this.y*a,this.z*a)};v3.prototype.neg=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this};
v3.prototype.norm=function(){var a=1/this.mag();this.set(this.x*a,this.y*a,this.z*a);return this};v3.prototype.cp=function(){return new v3(this.x,this.y,this.z)};v3.prototype.add=function(a){return v3.add(this,a)};v3.prototype.xyz=function(){return[this.x,this.y,this.z]};v3.prototype.toUniform=function(){return this.xyz()};v3.add=function(a,b){var c=new v3(a.x,a.y,a.z);c.x+=b.x;c.y+=b.y;c.z+=b.z;return c};v3.prototype.sub=function(a){return v3.sub(this,a)};
v3.sub=function(a,b){var c=new v3(a.x,a.y,a.z);c.x-=b.x;c.y-=b.y;c.z-=b.z;return c};v3.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};v3.cross=function(a,b){return new v3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)};v3.ZERO=function(){return new v3(0,0,0)};v3.ONE=function(){return new v3(1,1,1)};v3.RIGHT=function(){return new v3(1,0,0)};v3.UP=function(){return new v3(0,1,0)};v3.FORWARD=function(){return new v3(0,0,-1)};
v3.random=function(){return new v3(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1)};var v2=function(a,b){this.x=a||0;this.y=b||0};v2.prototype.set=function(a,b){this.x=a||0;this.y=b||0};v2.prototype.xy=function(){return[this.x,this.y]};v2.prototype.isOne=function(){return this.x==1&&this.y==1};v2.prototype.isZero=function(){return this.x==0&&this.y==0};v2.ZERO=function(){return new v2(0,0)};v2.ONE=function(){return new v2(1,1)};v2.random=function(){return new v2(Math.random()*2-1,Math.random()*2-1)};var m44=function(){this.array=[];this.identity()};m44.prototype.identity=function(){this.n11=1;this.n21=this.n14=this.n13=this.n12=0;this.n22=1;this.n32=this.n31=this.n24=this.n23=0;this.n33=1;this.n43=this.n42=this.n41=this.n34=0;this.n44=1};m44.prototype.ortho=function(a,b,c,d,e,f){var g,i,h;g=b-a;i=d-c;h=f-e;this.n11=2/g;this.n14=-((b+a)/g);this.n22=-2/i;this.n24=(d+c)/i;this.n33=2/h;this.n34=-((f+e)/h);this.makeArray()};
m44.prototype.perspective=function(a,b,c,d){a=c*Math.tan(a*Math.PI/360);var e=d-c;this.n11=c/(a*b);this.n22=c/a;this.n33=-(d+c)/e;this.n34=-(2*d*c)/e;this.n43=-1;this.n44=0;this.makeArray()};
m44.prototype.makeArray=function(){this.array[0]=this.n11;this.array[1]=this.n21;this.array[2]=this.n31;this.array[3]=this.n41;this.array[4]=this.n12;this.array[5]=this.n22;this.array[6]=this.n32;this.array[7]=this.n42;this.array[8]=this.n13;this.array[9]=this.n23;this.array[10]=this.n33;this.array[11]=this.n43;this.array[12]=this.n14;this.array[13]=this.n24;this.array[14]=this.n34;this.array[15]=this.n44};m44.prototype.toArray=function(){return this.array};var gl;
J3D.Engine=function(a,b,c){var d=a?a:document.createElement("canvas");if(!a)a=b&&b.resolution?b.resolution:1,d.width=window.innerWidth/a,d.height=window.innerHeight/a,d.style.width="100%",d.style.height="100%",document.body.appendChild(d);try{gl=d.getContext("experimental-webgl",c),gl.viewportWidth=d.width,gl.viewportHeight=d.height}catch(e){j3dlog("ERROR. Getting webgl context failed!");return}this.setClearColor(J3D.Color.black);gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);gl.enable(gl.CULL_FACE);gl.frontFace(gl.CW);
this.shaderAtlas=new J3D.ShaderAtlas;this.scene=new J3D.Scene;this.outCanvas=d;this._opaqueMeshes=[];this._transparentMeshes=[];this._lights=[];this.gl=gl};J3D.Engine.prototype.setClearColor=function(a){gl.clearColor(a.r,a.g,a.b,a.a)};J3D.Engine.prototype.render=function(){J3D.Time.tick();gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this.scene.numChildren>0&&this.renderScene()};
J3D.Engine.prototype.renderScene=function(){this._opaqueMeshes.length=0;this._transparentMeshes.length=0;for(var a=this._lights.length=0;a<this.scene.numChildren;a++)this.updateTransform(this.scene.childAt(a),null);this.camera.updateInverseMat();if(this.scene.skybox)gl.depthMask(!1),this.scene.skybox.renderer.mid=this.camera.camera.near+(this.camera.camera.far-this.camera.camera.near)/2,this.renderObject(this.scene.skybox),gl.depthMask(!0);for(a=0;a<this._lights.length;a++){var b=this._lights[a];
b.updateWorldPosition()}gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST);for(a=0;a<this._opaqueMeshes.length;a++)this.renderObject(this._opaqueMeshes[a]);gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);for(a=0;a<this._transparentMeshes.length;a++)b=this._transparentMeshes[a],gl.blendFunc(b.geometry.srcFactor!=null?b.geometry.srcFactor:gl.SRC_ALPHA,b.geometry.dstFactor!=null?b.geometry.dstFactor:gl.ONE),this.renderObject(b)};
J3D.Engine.prototype.renderObject=function(a){var b=this.shaderAtlas.getShader(a.renderer);gl.useProgram(b);b.uniforms.pMatrix&&gl.uniformMatrix4fv(b.uniforms.pMatrix.location,!1,this.camera.camera.projectionMat.toArray());b.uniforms.vMatrix&&gl.uniformMatrix4fv(b.uniforms.vMatrix.location,!1,this.camera.inverseMat);b.uniforms.mMatrix&&gl.uniformMatrix4fv(b.uniforms.mMatrix.location,!1,a.globalMatrix);b.uniforms.nMatrix&&gl.uniformMatrix3fv(b.uniforms.nMatrix.location,!1,a.normalMatrix);b.uniforms.uEyePosition&&
gl.uniform3fv(b.uniforms.uEyePosition.location,this.camera.worldPosition.xyz());b.uniforms.uTileOffset&&gl.uniform4fv(b.uniforms.uTileOffset.location,a.getTileOffset());J3D.ShaderUtil.setLights(b,this._lights);J3D.ShaderUtil.setAttributes(b,a.geometry);a.renderer.setup(b,a);gl.cullFace(a.renderer.cullFace||gl.BACK);b=a.renderer.drawMode!=null?a.renderer.drawMode:gl.TRIANGLES;a.geometry.hasElements?(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,a.geometry.elements.buffer),gl.drawElements(b,a.geometry.elements.size,
gl.UNSIGNED_SHORT,0)):gl.drawArrays(b,0,a.geometry.size)};J3D.Engine.prototype.updateTransform=function(a,b){a.updateWorld(b);for(var c=0;c<a.numChildren;c++)this.updateTransform(a.childAt(c),a);a.enabled&&(a.renderer&&a.geometry&&(a.geometry.renderMode==J3D.RENDER_AS_TRANSPARENT?this._transparentMeshes.push(a):this._opaqueMeshes.push(a)),a.light&&this._lights.push(a))};J3D.Scene=function(){var a=this,b=[];this.ambient=J3D.Color.black;this.add=function(){for(var c,d=0;d<arguments.length;d++){var e=arguments[d];c||(c=e);b.push(e);e.parent=null;a.numChildren=b.length}return c};this.recurse=function(a){for(var d=0;d<b.length;d++)b[d].recurse(a)};this.childAt=function(a){return b[a]};this.contains=function(a){return b.indexOf(a)>-1};this.remove=function(c,d){if(a.contains(c))return b.splice(b.indexOf(c),1),a.numChildren=b.length,!0;else if(d)for(var e=0;e<b.length;e++){if(b[e].remove(c))return!0}else return!1};
this.removeAll=function(){b=[];a.numChildren=0};this.addSkybox=function(a){this.skybox=new J3D.Transform;this.skybox.renderer=new J3D.BuiltinShaders.fetch("Skybox");this.skybox.renderer.uCubemap=a;this.skybox.geometry=J3D.Primitive.Cube(1,1,1).flip()}};J3D.Scene.prototype.find=function(a){a=a.split("/");for(var b=0;b<this.numChildren;b++)if(this.childAt(b).name==a[0])return a.length==1?this.childAt(b):this.childAt(b).find(a.slice(1));return null};J3D.Loader={};J3D.Loader.loadJSON=function(a,b){var c=new XMLHttpRequest;c.open("GET",a);c.onreadystatechange=function(){c.readyState==4&&b.call(null,JSON.parse(c.responseText))};c.send()};
J3D.Loader.parseJSONScene=function(a,b,c){var d=new J3D.Transform;d.light=new J3D.Light(J3D.AMBIENT);d.light.color=J3D.Loader.fromObject(J3D.Color,a.ambient);c.scene.add(d);for(var e in b)b[e]=new J3D.Mesh(b[e]);c.setClearColor(J3D.Loader.fromObject(J3D.Color,a.background));for(var f in a.textures)d=new J3D.Texture(a.path+a.textures[f].file),a.textures[f]=d;if(a.lightmaps){J3D.LightmapAtlas=[];for(e=0;e<a.lightmaps.length;e++)d=new J3D.Texture(a.path+a.lightmaps[e]),J3D.LightmapAtlas.push(d)}for(var g in a.materials){e=
a.materials[g];e=J3D.Loader.fetchShader(e.type,e);e.color=J3D.Loader.fromObject(J3D.Color,e.color);if(e.textureTile)e.textureTile=J3D.Loader.v2FromArray(e.textureTile);if(e.textureOffset)e.textureOffset=J3D.Loader.v2FromArray(e.textureOffset);if(e.colorTexture)e.colorTexture=a.textures[e.colorTexture],e.hasColorTexture=!0;a.materials[g]=e}for(var i in a.lights){e=a.lights[i];e=J3D.Loader.fromObject(J3D.Light,e);e.color=J3D.Loader.fromObject(J3D.Color,e.color);if(e.direction)e.direction=J3D.Loader.v3FromArray(e.direction);
a.lights[i]=e}for(var h in a.cameras)e=a.cameras[h],e=new J3D.Camera({fov:e.fov,near:e.near,far:e.far}),a.cameras[h]=e;i=function(a){var c=a.collider;switch(c.type){case "box":var d=J3D.Loader.v3FromArray(c.size),e=J3D.Loader.v3FromArray(c.center);a.collider=J3D.Collider.Box({minX:e.x+d.x*-0.5,maxX:e.x+d.x*0.5,minY:e.y+d.y*-0.5,maxY:e.y+d.y*0.5,minZ:e.z+d.z*-0.5,maxZ:e.z+d.z*0.5});break;case "sphere":e=J3D.Loader.v3FromArray(c.center);a.collider=J3D.Collider.Sphere(c.radius,e);break;case "mesh":a.collider=
J3D.Collider.Mesh(b[c.mesh])}};for(e=0;e<a.transforms.length;e++){h=a.transforms[e];h=J3D.Loader.fromObject(J3D.Transform,h);h.position=J3D.Loader.v3FromArray(h.position);h.rotation=J3D.Loader.v3FromArray(h.rotation);if(h.renderer)h.renderer=a.materials[h.renderer];if(h.mesh)h.geometry=b[h.mesh];if(h.light)h.light=a.lights[h.light];h.collider&&i(h);if(h.camera)h.camera=a.cameras[h.camera],c.camera=h;a.transforms[e]=h}i=function(b){for(var c=0;c<a.transforms.length;c++)if(a.transforms[c].uid==b)return a.transforms[c]};
for(e=0;e<a.transforms.length;e++)h=a.transforms[e],h.parent!=null?(h.parent=i(h.parent),h.parent.add(h)):c.scene.add(h)};J3D.Loader.fetchShader=function(a,b){var c=J3D.BuiltinShaders.fetch(a),d;for(d in b)c[d]=b[d];return c};J3D.Loader.fromObject=function(a,b){var c=new a,d;for(d in b)c[d]=b[d];return c};J3D.Loader.v2FromArray=function(a){return new v2(a[0],a[1])};J3D.Loader.v3FromArray=function(a){return new v3(a[0],a[1],a[2])};
J3D.Loader.loadGLSL=function(a,b){var c=new XMLHttpRequest;c.open("GET",a);c.onreadystatechange=function(){c.readyState==4&&b.call(null,J3D.ShaderUtil.parseGLSL(c.responseText))};c.send()};J3D.Geometry=function(){this.renderMode=J3D.RENDER_AS_OPAQUE;this.arrays=[];this.hasElements=!1};J3D.Geometry.prototype.setTransparency=function(a,b,c){a?(this.renderMode=J3D.RENDER_AS_TRANSPARENT,this.srcFactor=b,this.dstFactor=c):this.renderMode=J3D.RENDER_AS_OPAQUE};J3D.Geometry.prototype.addArray=function(a,b,c,d,e){if(!d)d=gl.FLOAT;if(!e)e=gl.STATIC_DRAW;a=new J3D.Geometry.Attribute(a,b,c,d,e,gl.ARRAY_BUFFER);this.arrays.push(a);this.size=a.size;return a};
J3D.Geometry.prototype.replaceArray=function(a,b,c){if(!c)c=gl.STATIC_DRAW;a.data=b;gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer);gl.bufferData(gl.ARRAY_BUFFER,b,c)};J3D.Geometry.prototype.addElement=function(a,b,c){if(!b)b=gl.UNSIGNED_SHORT;if(!c)c=gl.STATIC_DRAW;this.elements=new J3D.Geometry.Attribute("",a,0,b,c,gl.ELEMENT_ARRAY_BUFFER);this.hasElements=!0};
J3D.Geometry.Attribute=function(a,b,c,d,e,f){this.name=a;this.data=b;this.buffer=gl.createBuffer();gl.bindBuffer(f,this.buffer);gl.bufferData(f,b,e);this.size=c>0?b.length/c:b.length;this.itemSize=c;this.type=d};J3D.Mesh=function(a){that=this;J3D.Geometry.call(this);this.hasUV1=!1;this.calculateBoundingBox=function(){for(var c=a.vertices,b={minX:Number.MAX_VALUE,maxX:-Number.MIN_VALUE,minY:Number.MAX_VALUE,maxY:-Number.MIN_VALUE,minZ:Number.MAX_VALUE,maxZ:-Number.MIN_VALUE},e=0;e<c.length;e+=3)b.minX=Math.min(b.minX,c[e+0]),b.maxX=Math.max(b.maxX,c[e+0]),b.minY=Math.min(b.minY,c[e+1]),b.maxY=Math.max(b.maxY,c[e+1]),b.minZ=Math.min(b.minZ,c[e+2]),b.maxZ=Math.max(b.maxZ,c[e+2]);this.boundingBox=b};for(var b in a)switch(b){case "vertices":this.vertexPositionBuffer=
this.addArray("aVertexPosition",new Float32Array(a[b]),3);break;case "colors":a[b].length>0&&this.addArray("aVertexColor",new Float32Array(a[b]),4);break;case "normals":this.vertexNormalBuffer=a[b].length>0?this.addArray("aVertexNormal",new Float32Array(a[b]),3):this.addArray("aVertexNormal",new Float32Array(this.size*3),3);break;case "uv1":a[b].length>0?this.addArray("aTextureCoord",new Float32Array(a[b]),2):this.addArray("aTextureCoord",new Float32Array(this.size*2),2);this.hasUV1=!0;break;case "uv2":a[b].length>
0&&this.addArray("aTextureCoord2",new Float32Array(a[b]),2);break;case "tris":a[b].length>0&&this.addElement(new Uint16Array(a[b]));break;default:j3dlog("WARNING! Unknown attribute: "+b)}this.flip=function(){var a=[],b=[],e=this.vertexPositionBuffer.data,f=this.vertexNormalBuffer.data,g;for(g=0;g<e.length;g+=3)a.push(e[g],e[g+2],e[g+1]),b.push(f[g],f[g+1],f[g+2]);this.replaceArray(this.vertexPositionBuffer,new Float32Array(a));this.replaceArray(this.vertexNormalBuffer,new Float32Array(b));return this}};
J3D.Mesh.prototype=new J3D.Geometry;J3D.Mesh.prototype.constructor=J3D.Mesh;J3D.Mesh.prototype.supr=J3D.Geometry.prototype;J3D.Light=function(a){this.type=a!=null?a:J3D.NONE;this.color=J3D.Color.white;this.intensity=1;this.angle=this.angleFalloff=0};J3D.NONE=-1;J3D.AMBIENT=0;J3D.DIRECT=1;J3D.POINT=2;J3D.SPOTLIGHT=3;J3D.HEMISPHERE=4;J3D.SPHERICAL_HARMONICS=5;J3D.PERSPECTIVE=0;J3D.ORTHO=1;
J3D.Camera=function(a){that=this;a||(a={});if(!a.type)a.type=J3D.PERSPECTIVE;if(!a.near)a.near=1;if(!a.far)a.far=1E3;if(a.type==J3D.PERSPECTIVE){if(!a.fov)a.fov=45;if(!a.aspect)a.aspect=gl.viewportWidth/gl.viewportHeight}else{if(a.left==null)a.left=0;if(a.right==null)a.right=1;if(a.top==null)a.top=0;if(a.bottom==null)a.bottom=1}this.near=a.near;this.far=a.far;this.projectionMat=new m44;a.type==J3D.PERSPECTIVE?this.projectionMat.perspective(a.fov,a.aspect,a.near,a.far):this.projectionMat.ortho(a.left,
a.right,a.top,a.bottom,a.near,a.far)};J3D.Texture=function(a,b){var c=this;this.tex=gl.createTexture();b||(b={});this.isVideo=this.loaded=!1;this.onLoad=b.onLoad;this.mipmap=b.mipmap!=null?b.mipmap:!0;this.flip=b.flip!=null?b.flip:!0;this.magFilter=b.magFilter||gl.LINEAR;this.minFilter=b.minFilter||gl.LINEAR_MIPMAP_NEAREST;var d=function(){var d=c.src&&c.src.width>0&&c.src.height>0&&(c.src.width&c.src.width-1)==0&&(c.src.height&c.src.height-1)==0;if(!c.wrapMode)c.wrapMode=b.wrapMode||d?gl.REPEAT:gl.CLAMP_TO_EDGE;gl.bindTexture(gl.TEXTURE_2D,
c.tex);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,c.flip);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c.src);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,c.magFilter);d?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,c.minFilter):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);d?(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,c.wrapMode),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,c.wrapMode)):(c.wrapMode!=gl.CLAMP_TO_EDGE&&j3dlog("WARNING! Texture: "+
a+" : only CLAMP_TO_EDGE wrapMode is supported for non-power-of-2 textures."),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE));c.mipmap&&d&&gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);c.onLoad&&c.onLoad.call();c.loaded=!0},e=function(a){c.src=new Image;c.src.onload=function(){d()};c.src.src=a},f=function(a){c.isVideo=!0;c.src=document.createElement("video");c.src.src=a;c.src.preload="auto";
c.src.addEventListener("canplaythrough",function(){c.src.play();d()});c.src.load()};if(typeof a=="string"){var g=a.substring(a.lastIndexOf(".")+1).toLowerCase();switch(g){case "jpg":case "png":case "gif":e(a);break;case "mp4":case "webm":case "ogv":f(a);break;default:j3dlog("Unsupported texture format: "+g+" in "+a)}}else if(a.getContext)c.src=a,d()};
J3D.Texture.prototype.update=function(){this.loaded&&this.isVideo&&(gl.bindTexture(gl.TEXTURE_2D,this.tex),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.src),gl.bindTexture(gl.TEXTURE_2D,null))};J3D.Texture.prototype.toUniform=function(){this.update();return this.tex};J3D.Cubemap=function(a){var b=this;this.tex=gl.createTexture();this.facesLeft=6;this.faceImages={};var c=function(){gl.bindTexture(gl.TEXTURE_CUBE_MAP,b.tex);gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b.faceImages.front);gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b.faceImages.back);gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b.faceImages.up);gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,
gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b.faceImages.down);gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b.faceImages.right);gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b.faceImages.left);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_CUBE_MAP,
gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.generateMipmap(gl.TEXTURE_CUBE_MAP);gl.bindTexture(gl.TEXTURE_CUBE_MAP,null)},d=function(a,d){typeof d=="string"?(b.faceImages[a]=new Image,b.faceImages[a].onload=function(){b.facesLeft--;b.facesLeft==0&&c()},b.faceImages[a].src=d):d.getContext&&(b.faceImages[a]=d,b.facesLeft--,b.facesLeft==0&&c())};d("left",a.left);d("right",a.right);d("up",a.up);d("down",a.down);d("back",a.back);d("front",a.front)};J3D.Cubemap.prototype.toUniform=function(){return this.tex};J3D.Transform=function(a,b){var c=this;this.uid=b||0;this.name=a;var d=[];this.numChildren=0;this.position=v3.ZERO();this.rotation=v3.ZERO();this.scale=v3.ONE();this.worldPosition=v3.ZERO();this.matrix=mat4.create();this.globalMatrix=mat4.create();this.normalMatrix=mat3.create();this._lockedMatrix=this.isStatic=!1;this.enabled=!0;this.textureTile=v2.ONE();this.textureOffset=v2.ZERO();this.add=function(a){for(var b,g=0;g<arguments.length;g++)a=arguments[g],b||(b=a),d.push(a),a.parent=c,c.numChildren=
d.length;return b};this.contains=function(a){return d.indexOf(a)>-1};this.recurse=function(a){a(c);for(var b=0;b<d.length;b++)d[b].recurse(a)};this.remove=function(a,b){if(c.contains(a))return d.splice(d.indexOf(a),1),c.numChildren=d.length,a.parent=null,!0;else if(b)for(var g=0;g<d.length;g++){if(d[g].remove(a))return!0}else return!1};this.childAt=function(a){return d[a]};this.path=function(){var a=[];a.push(c.name);for(var b=c.parent;b!=null;)a.push(b.name),b=b.parent;return a.reverse().join("/")}};
J3D.Transform.prototype.clone=function(){var a=new J3D.Transform;a.position=this.position.cp();a.rotation=this.rotation.cp();a.scale=this.scale.cp();a.isStatic=this.isStatic;a.renderer=this.renderer;a.mesh=this.mesh;a.camera=this.camera;a.light=this.light;a.collider=this.collider;return a};J3D.Transform.prototype.transformDirection=function(a){var b=mat4.create(),c=vec3.create();c=mat4.multiplyVec3(mat3.toMat4(this.normalMatrix,b),a.xyz(),c);return(new v3(c[0],c[1],c[2])).norm()};
J3D.Transform.prototype.forward=function(){var a=mat4.create();a=mat4.multiplyVec3(mat3.toMat4(this.normalMatrix,a),[0,0,-1]);return(new v3(a[0],a[1],a[2])).norm()};J3D.Transform.prototype.left=function(){var a=mat4.create();a=mat4.multiplyVec3(mat3.toMat4(this.normalMatrix,a),[-1,0,0]);return(new v3(a[0],a[1],a[2])).norm()};
J3D.Transform.prototype.updateWorld=function(a){if(!this._lockedMatrix&&(mat4.identity(this.matrix),mat4.translate(this.matrix,[this.position.x,this.position.y,this.position.z]),mat4.rotateZ(this.matrix,this.rotation.z),mat4.rotateX(this.matrix,this.rotation.x),mat4.rotateY(this.matrix,this.rotation.y),mat4.scale(this.matrix,[this.scale.x,this.scale.y,this.scale.z]),a!=null?mat4.multiply(a.globalMatrix,this.matrix,this.globalMatrix):this.globalMatrix=this.matrix,mat4.toInverseMat3(this.globalMatrix,
this.normalMatrix),mat3.transpose(this.normalMatrix),this.isStatic))this._lockedMatrix=!0};J3D.Transform.prototype.updateWorldPosition=function(){var a=[0,0,0];mat4.multiplyVec3(this.globalMatrix,a);this.worldPosition.x=a[0];this.worldPosition.y=a[1];this.worldPosition.z=a[2]};
J3D.Transform.prototype.getTileOffset=function(){var a,b;a=this.renderer.textureTile&&this.textureTile.isOne()?this.renderer.textureTile.xy():this.textureTile.xy();b=this.renderer.textureOffset&&this.textureOffset.isZero()?this.renderer.textureOffset.xy():this.textureOffset.xy();return a.concat(b)};J3D.Transform.prototype.find=function(a){for(var b=0;b<this.numChildren;b++)if(this.childAt(b).name==a[0])return a.length==1?this.childAt(b):this.childAt(b).find(a.slice(1));return null};
J3D.Transform.prototype.updateInverseMat=function(){if(!this.inverseMat)this.inverseMat=mat4.create();mat4.inverse(this.globalMatrix,this.inverseMat);this.updateWorldPosition()};J3D.ShaderAtlas=function(){this.shaders={};this.programs={};this.shaderCount=0};
J3D.ShaderAtlas.prototype.compileShaderSource=function(a,b,c,d){var e="";if(d.includes&&d.includes.length>0)for(var f=0;f<d.includes.length;f++)e+=J3D.ShaderSource[d.includes[f]];e+=d.common||"";if(c==gl.VERTEX_SHADER){var g="";if(d.vertexIncludes&&d.vertexIncludes.length>0)for(f=0;f<d.vertexIncludes.length;f++)g+=J3D.ShaderSource[d.vertexIncludes[f]]}else if(g="",d.fragmentIncludes&&d.fragmentIncludes.length>0)for(f=0;f<d.fragmentIncludes.length;f++)g+=J3D.ShaderSource[d.fragmentIncludes[f]];b=e+
g+b;c=gl.createShader(c);gl.shaderSource(c,b);gl.compileShader(c);gl.getShaderParameter(c,gl.COMPILE_STATUS)||j3dlog("ERROR. Shader compile error: "+gl.getShaderInfoLog(c));this.programs[a]=c};
J3D.ShaderAtlas.prototype.linkShader=function(a){a=a.name;var b=this.programs[a+"Vert"],c=this.programs[a+"Frag"],d=gl.createProgram();gl.attachShader(d,b);gl.attachShader(d,c);gl.linkProgram(d);gl.getProgramParameter(d,gl.LINK_STATUS)||console.log("Error linking program "+a);gl.useProgram(d);c=0;d.uniforms={};var e=gl.getProgramParameter(d,gl.ACTIVE_UNIFORMS);for(b=0;b<e;b++){var f=gl.getActiveUniform(d,b);d.uniforms[f.name]=f;d.uniforms[f.name].location=gl.getUniformLocation(d,f.name);if(J3D.ShaderUtil.isTexture(f.type))d.uniforms[f.name].texid=
c,c++}d.attributes={};c=gl.getProgramParameter(d,gl.ACTIVE_ATTRIBUTES);for(b=0;b<c;b++)e=gl.getActiveAttrib(d,b),d.attributes[e.name]=gl.getAttribLocation(d,e.name),gl.enableVertexAttribArray(d.attributes[e.name]);this.shaderCount++;this.shaders[a]=d};
J3D.ShaderAtlas.prototype.getShader=function(a){this.shaders[a.name]||(this.compileShaderSource(a.name+"Vert",a.vertSource(),gl.VERTEX_SHADER,a.metaData),this.compileShaderSource(a.name+"Frag",a.fragSource(),gl.FRAGMENT_SHADER,a.metaData),this.linkShader(a));return this.shaders[a.name]};J3D.Particles=function(a){this.renderMode=J3D.RENDER_AS_OPAQUE;this.vertSize=3;this.vertices=a.positions;this.vertNum=a.positions.length/this.vertSize;this.vertBuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.vertBuf);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.STATIC_DRAW);if(a.colors)this.colorSize=4,this.colors=a.colors,this.colorBuf=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuf),gl.bufferData(gl.ARRAY_BUFFER,this.colors,gl.STATIC_DRAW);if(a.animation){if(!a.animationSize)throw Error("Please specify the size of animaton attribute");
this.animSize=a.animationSize;this.animation=a.animation;this.animBuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.animBuf);gl.bufferData(gl.ARRAY_BUFFER,this.animation,gl.STATIC_DRAW)}};J3D.Particles.prototype.setTransparency=function(a,b,c){a?(this.renderMode=J3D.RENDER_AS_TRANSPARENT,this.srcFactor=b,this.dstFactor=c):this.renderMode=J3D.RENDER_AS_OPAQUE};J3D.Postprocess=function(a){this.drawMode=gl.TRIANGLES;this.engine=a;this.fbo=new J3D.FrameBuffer;this.geometry=J3D.Primitive.FullScreenQuad();this.filter=null};J3D.Postprocess.prototype.render=function(){this.fbo.bind();this.engine.render();this.fbo.unbind();this.renderEffect(this.fbo.texture)};
J3D.Postprocess.prototype.renderEffect=function(a){this.program=engine.shaderAtlas.getShader(this.filter);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.program);J3D.ShaderUtil.setTexture(this.program,0,"uTexture",a);J3D.ShaderUtil.setAttributes(this.program,this.geometry);this.filter.setup(this.program);gl.drawArrays(this.drawMode,0,this.geometry.size)};J3D.FrameBuffer=function(a,b){this.width=a?a:gl.viewportWidth;this.height=b?b:gl.viewportHeight;this.fbo=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo);this.texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);this.depthBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthBuffer);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,
null);gl.bindFramebuffer(gl.FRAMEBUFFER,null)};J3D.FrameBuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo)};J3D.FrameBuffer.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null)};J3D.Primitive={};
J3D.Primitive.Cube=function(a,b,c){var d=J3D.Primitive.getEmpty();a*=0.5;b*=0.5;c*=0.5;J3D.Primitive.addQuad(d,new v3(-a,b,c),new v3(a,b,c),new v3(a,-b,c),new v3(-a,-b,c));J3D.Primitive.addQuad(d,new v3(a,b,-c),new v3(-a,b,-c),new v3(-a,-b,-c),new v3(a,-b,-c));J3D.Primitive.addQuad(d,new v3(-a,b,-c),new v3(-a,b,c),new v3(-a,-b,c),new v3(-a,-b,-c));J3D.Primitive.addQuad(d,new v3(a,b,c),new v3(a,b,-c),new v3(a,-b,-c),new v3(a,-b,c));J3D.Primitive.addQuad(d,new v3(a,b,c),new v3(-a,b,c),new v3(-a,b,-c),
new v3(a,b,-c));J3D.Primitive.addQuad(d,new v3(a,-b,c),new v3(a,-b,-c),new v3(-a,-b,-c),new v3(-a,-b,c));return new J3D.Mesh(d)};J3D.Primitive.FullScreenQuad=function(){var a=new J3D.Geometry;a.addArray("aVertexPosition",new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),2);a.addArray("aTextureCoord",new Float32Array([0,1,1,1,1,0,0,1,1,0,0,0]),2);return a};
J3D.Primitive.Plane=function(a,b,c,d,e,f){var g=J3D.Primitive.getEmpty();e||(e=0);f||(f=0);a*=0.5;b*=0.5;c||(c=1);d||(d=1);e=-a+e;f=b+f;a=a*2/c;b=b*2/d;for(var i=0;i<c;i++)for(var h=0;h<d;h++){var j=e+i*a,k=j+a,l=f-h*b,n=l-b,o=new v3(j,l,0);l=new v3(k,l,0);k=new v3(k,n,0);j=new v3(j,n,0);J3D.Primitive.addQuad(g,o,l,k,j,1/c*i,1/c*(i+1),1-1/d*(h+1),1-1/d*h)}return new J3D.Mesh(g)};
J3D.Primitive.Sphere=function(a,b,c){var d=J3D.Primitive.getEmpty(),e=[],f=[];a=a||50;b=Math.max(3,Math.floor(b)||8);c=Math.max(3,Math.floor(c)||6);var g=Math.PI*2,i=Math.PI,h,j;for(j=0;j<=c;j++)for(h=0;h<=b;h++){var k=h/b,l=j/c;e.push(new v3(-a*Math.cos(0+k*g)*Math.sin(0+l*i),a*Math.cos(0+l*i),a*Math.sin(0+k*g)*Math.sin(0+l*i)));f.push([k,1-l])}for(j=0;j<=c;j++)for(h=0;h<b;h++){a=e[j*b+h+0];g=e[j*b+h+1];i=e[(j+1)*b+h+1];k=e[(j+1)*b+h+0];l=f[j*b+h+0];var n=f[j*b+h+1],o=f[(j+1)*b+h+1],u=f[(j+1)*b+
h+0],p=a.cp().norm(),q=g.cp().norm(),r=i.cp().norm(),t=k.cp().norm(),m=d.vertices.length/3;d.vertices.push(a.x,a.y,a.z,g.x,g.y,g.z,i.x,i.y,i.z,k.x,k.y,k.z);d.uv1.push(l[0],l[1],n[0],n[1],o[0],o[1],u[0],u[1]);d.normals.push(p.x,p.y,p.z,q.x,q.y,q.z,r.x,r.y,r.z,t.x,t.y,t.z);d.tris.push(m+0,m+1,m+2,m+0,m+2,m+3)}return new J3D.Mesh(d)};J3D.Primitive.getEmpty=function(){var a={};a.vertices=[];a.normals=[];a.uv1=[];a.tris=[];return a};
J3D.Primitive.addQuad=function(a,b,c,d,e,f,g,i,h){var j=v3.cross(b.sub(c),c.sub(d)).norm(),k=a.vertices.length/3;f=f?f:0;g=g?g:1;i=i?i:0;h=h?h:1;a.vertices.push(b.x,b.y,b.z,c.x,c.y,c.z,d.x,d.y,d.z,e.x,e.y,e.z);a.normals.push(j.x,j.y,j.z,j.x,j.y,j.z,j.x,j.y,j.z,j.x,j.y,j.z);a.uv1.push(f,h,g,h,g,i,f,i);a.tris.push(k,k+1,k+2,k,k+2,k+3)};J3D.Shader=function(a,b,c,d){if(!a)throw Error("You must specify a name for custom shaders");if(b==null||c==null)throw Error("You must pass a vertex and fragment shader source for custom shaders");this.name=a;this.drawMode=4;this._vertSource=b;this._fragSource=c;this.reloadStaticUniforms=!0;this.su={};this.loadedStaticTextures={};this.metaData=d||{};this.cloneCount=0};J3D.Shader.prototype.vertSource=function(){return this._vertSource};J3D.Shader.prototype.fragSource=function(){return this._fragSource};
J3D.Shader.prototype.setup=function(a){if(this.reloadStaticUniforms)this.loadedStaticTextures={};this.uTime=J3D.Time.time;var b=0,c;for(c in a.uniforms)this.reloadStaticUniforms&&this.su[c]!=null&&this[c]==null&&this.su[c].loaded==null&&J3D.ShaderUtil.setUniform(c,a,this.su),this.su[c]!=null&&this[c]==null&&this.su[c].loaded&&!this.loadedStaticTextures[c]&&(J3D.ShaderUtil.setUniform(c,a,this.su),this.loadedStaticTextures[c]=!0),this[c]!=null&&(b++,J3D.ShaderUtil.setUniform(c,a,this));this.reloadStaticUniforms=
!1};J3D.Shader.prototype.clone=function(){this.cloneCount++;var a=new J3D.Shader(this.name,this._vertSource,this._fragSource);for(s in this)typeof this[s]!=="function"&&this.hasOwnProperty(s)&&s!="name"&&(a[s]=this[s]);if(this.hasOwnProperty("setup"))a.setup=this.setup;a.su={};for(ss in this.su)typeof this.su[ss]!=="function"&&this.su.hasOwnProperty(ss)&&(a.su[ss]=this.su[ss]);a.reloadStaticUniforms=!0;return a};J3D.ShaderSource={};J3D.ShaderSource.CopyFilter="//#name CopyFilter\n//#description All this shader does is to render a texture (typically a render texture) pixel-to-pixel.\n//#description It is useful in effects like Persistence\n//#author bartekd\n//#include CommonFilterInclude\n//#vertex\n//#include BasicFilterVertex\n//#fragment\nuniform sampler2D uTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 p = texture2D(uTexture, vTextureCoord);\ngl_FragColor = vec4(p.rgb, 1.0);\n}\n";
J3D.ShaderSource.Depth="//#name Depth\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying float depth;\nvoid main(void) {\nvec4 p = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * p;\ndepth = gl_Position.z/gl_Position.w;\n}\n//#fragment\nvarying float depth;\nvoid main(void) {\nfloat d = 1.0 - depth;\ngl_FragColor = vec4(d, d, d, 1.0);\n}\n";J3D.ShaderSource.Gouraud="//#name Gouraud\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\n//#include Lights\nuniform float specularIntensity;\nuniform float shininess;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 p = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * p;\nvTextureCoord = getTextureCoord(aTextureCoord);\nvec3 n = normalize( nMatrix * aVertexNormal );\nvLight = computeLights(p, n, specularIntensity, shininess);\n}\n//#fragment\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\ngl_FragColor = vec4(tc.rgb * vLight, color.a);\n}\n";
J3D.ShaderSource.Lightmap="//#name Lightmap\n//#author bartekd\n//#include CommonInclude\nvarying vec2 vTextureCoord;\nvarying vec2 vTextureCoord2;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\n//#vertex\n//#include VertexInclude\nuniform vec4 lightmapAtlas;\nvoid main(void) {\nvTextureCoord = getTextureCoord(aTextureCoord);\nvTextureCoord2 = aTextureCoord2 * lightmapAtlas.xy + lightmapAtlas.zw;\nvNormal = nMatrix * aVertexNormal;\nvPosition = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * vPosition;\ngl_PointSize = 5.0;\n}\n//#fragment\n//#include Lights\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform sampler2D lightmapTexture;\nuniform float specularIntensity;\nuniform float shininess;\nvoid main(void) {\nvec4 tc = texture2D(colorTexture, vTextureCoord);\nvec4 lm = texture2D(lightmapTexture, vTextureCoord2);\nfloat si = specularIntensity * tc.r;\nvec3 ltc = computeLights(vPosition, vNormal, si, shininess);\nvec3 lmc = lm.rgb * lm.a;\nif(tc.a < 0.1) discard;\nelse gl_FragColor = vec4(color.rgb * tc.rgb * (ltc + lmc), 1.0);\n}\n";
J3D.ShaderSource.Normal2Color="//#name Normal2Color\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec3 vColor;\nvoid main(void) {\ngl_Position = mvpMatrix() * vec4(aVertexPosition, 1.0);\nvColor = normalize( aVertexNormal / 2.0 + vec3(0.5) );\n}\n//#fragment\nvarying vec3 vColor;\nvoid main(void) {\ngl_FragColor = vec4(vColor, 1.0);\n}\n";J3D.ShaderSource.Phong="//#name Phong\n//#description Classic phong shader\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec4 vPosition;\nvarying vec2 vTextureCoord;\nvarying vec3 vNormal;\nvoid main(void) {\nvTextureCoord = getTextureCoord(aTextureCoord);\nvNormal = nMatrix * aVertexNormal;\nvPosition = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * vPosition;\ngl_PointSize = 5.0;\n}\n//#fragment\n//#include Lights\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nuniform float specularIntensity;\nuniform float shininess;\nvarying vec4 vPosition;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvarying vec3 vNormal;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\nvec3 l = computeLights(vPosition, vNormal, specularIntensity, shininess);\ngl_FragColor = vec4(tc.rgb * l, color.a);\n}\n";
J3D.ShaderSource.Reflective="//#name Reflective\n//#description Based on Cg tutorial: http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter07.html\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec3 vNormal;\nvarying vec3 refVec;\nvoid main(void) {\ngl_Position = mvpMatrix() * vec4(aVertexPosition, 1.0);\nvNormal = normalize(nMatrix * aVertexNormal);\nvec3 incident = normalize( (vec4(aVertexPosition, 1.0) * mMatrix).xyz - uEyePosition);\nrefVec = reflect(incident, vNormal);\n}\n//#fragment\nuniform samplerCube uCubemap;\nvarying vec3 refVec;\nvoid main(void) {\ngl_FragColor = textureCube(uCubemap, refVec);\n}\n";
J3D.ShaderSource.Selflit="//#name Selflit\n//#author bartekd\n//#description A very basic shader that uses a color and/or a texture and no lights\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * mMatrix * vec4(aVertexPosition, 1.0);\nvTextureCoord = getTextureCoord(aTextureCoord);\n}\n//#fragment\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\ngl_FragColor = vec4(tc.rgb, color.a);\n}\n";
J3D.ShaderSource.Skybox="//#name Skybox\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nuniform float mid;\nvarying vec3 vVertexPosition;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * vec4(uEyePosition + aVertexPosition * mid, 1.0);\nvVertexPosition = aVertexPosition;\n}\n//#fragment\nuniform samplerCube uCubemap;\nvarying vec3 vVertexPosition;\nvoid main(void) {\ngl_FragColor = textureCube(uCubemap, vVertexPosition);\n}\n";J3D.ShaderSource.Toon="//#name Toon\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\n//#include Lights\nvarying float vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 p = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * p;\ngl_PointSize = 10.0;\nvTextureCoord = getTextureCoord(aTextureCoord);\nvec3 n = normalize( nMatrix * aVertexNormal );\nvLight = computeLights(p, n, 0.0, 0.0).r;\n}\n//#fragment\nuniform vec4 uColor;\nuniform sampler2D uColorSampler;\nvarying float vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 tc = texture2D(uColorSampler, vec2(vLight, 0.5) );\ngl_FragColor = vec4(tc.rgb, 1.0);\n}\n";
J3D.ShaderSource.Vignette="//#name Vignette\n//#author bartekd\n//#vertex\n//#include BasicFilterVertex\n//#fragment\n//#include CommonFilterInclude\nuniform sampler2D uTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec2 m = vec2(0.5, 0.5);\nfloat d = distance(m, vTextureCoord) * 1.0;\nvec3 c = texture2D(uTexture, vTextureCoord).rgb * (1.0 - d * d);\ngl_FragColor = vec4(c.rgb, 1.0);\n}\n";J3D.ShaderSource.BasicFilterVertex="//#name BasicFilterVertex\n//#description A basic vertex shader for filters that use a full screen quad and have all the logic in fragment shader\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_Position = vec4(aVertexPosition, 0.0, 1.0);\nvTextureCoord = aTextureCoord;\n}\n";
J3D.ShaderSource.CommonFilterInclude="//#name CommonFilterInclude\n//#description Common uniforms and function for filters\nprecision mediump float;\nuniform float uTime;\nfloat whiteNoise(vec2 uv, float scale) {\nfloat x = (uv.x + 0.2) * (uv.y + 0.2) * (10000.0 + uTime);\nx = mod( x, 13.0 ) * mod( x, 123.0 );\nfloat dx = mod( x, 0.005 );\nreturn clamp( 0.1 + dx * 100.0, 0.0, 1.0 ) * scale;\n}\n";J3D.ShaderSource.CommonInclude="//#name CommonInclude\n//#description Collection of common uniforms, functions and structs to include in shaders (both fragment and vertex)\nprecision mediump float;\nuniform float uTime;\nuniform mat4 mMatrix;\nuniform mat4 vMatrix;\nuniform mat3 nMatrix;\nuniform mat4 pMatrix;\nuniform vec3 uEyePosition;\nuniform vec4 uTileOffset;\nmat4 mvpMatrix() {\nreturn pMatrix * vMatrix * mMatrix;\n}\nmat4 mvMatrix() {\nreturn vMatrix * mMatrix;\n}\nfloat luminance(vec3 c) {\nreturn c.r * 0.299 + c.g * 0.587 + c.b * 0.114;\n}\nfloat brightness(vec3 c) {\nreturn c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722;\n}\nvec2 getTextureCoord(vec2 uv) {\nreturn uv * uTileOffset.xy + uTileOffset.zw;\n}\n";
J3D.ShaderSource.Lights="//#name Lights\n//#description Collection of light equations\n//#description Requires CommonInclude\nstruct lightSource {\nint type;\nvec3 direction;     // used by directional and spotlight (global direction of the transfom)\nvec3 position;      // used by point, spotlight (it's the global position of the transform)\nvec3 color;         // used by d/p/s and hemisphere\nfloat intensity;    // used by spherical harmonics & d/p/s\nfloat angleFalloff; // used by hemisphere and spotlight\nfloat angle;        // used by spotlight\n};\nuniform lightSource uLight[4];\nconst float C1 = 0.429043;\nconst float C2 = 0.511664;\nconst float C3 = 0.743125;\nconst float C4 = 0.886227;\nconst float C5 = 0.247708;\n//const vec3 L00  = vec3( 0.871297,  0.875222,  0.864470);\n//const vec3 L1m1 = vec3( 0.175058,  0.245335,  0.312891);\n//const vec3 L10  = vec3( 0.034675,  0.036107,  0.037362);\n//const vec3 L11  = vec3(-0.004629, -0.029448, -0.048028);\n//const vec3 L2m2 = vec3(-0.120535, -0.121160, -0.117507);\n//const vec3 L2m1 = vec3( 0.003242,  0.003624,  0.007511);\n//const vec3 L20  = vec3(-0.028667, -0.024926, -0.020998);\n//const vec3 L21  = vec3(-0.077539, -0.086325, -0.091591);\n//const vec3 L22  = vec3(-0.161784, -0.191783, -0.219152);\nconst vec3 L00  = vec3( 0.078908,  0.043710,  0.054161);\nconst vec3 L1m1 = vec3( 0.039499,  0.034989,  0.060488);\nconst vec3 L10  = vec3(-0.033974, -0.018236, -0.026940);\nconst vec3 L11  = vec3(-0.029213, -0.005562,  0.000944);\nconst vec3 L2m2 = vec3(-0.011141, -0.005090, -0.012231);\nconst vec3 L2m1 = vec3(-0.026240, -0.022401, -0.047479);\nconst vec3 L20  = vec3(-0.015570, -0.009471, -0.014733);\nconst vec3 L21  = vec3( 0.056014,  0.021444,  0.013915);\nconst vec3 L22  = vec3( 0.021205, -0.005432, -0.030374);\nvec3 sphericalHarmonics(vec3 n, lightSource ls) {\nvec3 c =  C1 * L22 * (n.x * n.x - n.y * n.y) +\nC3 * L20 * n.z * n.z +\nC4 * L00 -\nC5 * L20 +\n2.0 * C1 * L2m2 * n.x * n.y +\n2.0 * C1 * L21  * n.x * n.z +\n2.0 * C1 * L2m1 * n.y * n.z +\n2.0 * C2 * L11  * n.x +\n2.0 * C2 * L1m1 * n.y +\n2.0 * C2 * L10  * n.z;\nc *= ls.intensity;\nreturn c;\n}\nvec3 hemisphere(vec4 p, vec3 n, float si, float sh, lightSource ls) {\nvec3 lv = normalize(ls.position - p.xyz);\nfloat dif = (dot(n, lv) * 0.5 + 0.5);\ndif = smoothstep(ls.angleFalloff, 1.0-ls.angleFalloff, dif);\nfloat spec = 0.0;\nif(si > 0.0) {\nvec3 eyed = normalize(uEyePosition - p.xyz);\nvec3 refd = reflect(-lv, n);\nspec = pow(max(dot(refd, eyed), 0.0), sh) * si;\n};\nreturn ls.color * dif + ls.color * spec;\n}\nvec3 phong(vec4 p, vec3 n, float si, float sh, lightSource ls){\nvec3 ld;\nif(ls.type == 1) ld = -ls.direction;\nelse ld = normalize(ls.position - p.xyz);\nfloat dif = max(dot(n, ld), 0.0);\nfloat spec = 0.0;\nif(si > 0.0) {\nvec3 eyed = normalize(uEyePosition - p.xyz);\nvec3 refd = reflect(-ld, n);\nspec = pow( (dot(refd, eyed) + 1.0) * 0.5, sh * 4.0) * si;\n}\nif(ls.type == 3) {\nfloat dd = dot(ld, -ls.direction);\nfloat ca = cos(ls.angle);\nfloat cf = cos(ls.angle + ls.angleFalloff);\nfloat spm = smoothstep(cf, ca, dd);\ndif *= spm;\nspec *= spm;\n}\ndif *= ls.intensity;\nreturn ls.color * dif + ls.color * spec;\n}\nvec3 singleLight(vec4 p, vec3 n, float si, float sh, lightSource ls) {\nif(ls.type == 0) {\nreturn ls.color;\n} else if(ls.type > 0 && ls.type < 4) {\nreturn phong(p, n, si, sh, ls);\n} else if(ls.type == 4) {\nreturn hemisphere(p, n, si, sh, ls);\n} else if(ls.type == 5) {\nreturn sphericalHarmonics(n, ls);\n} else {\nreturn vec3(0);\n}\n}\nvec3 computeLights(vec4 p, vec3 n, float si, float sh) {\nvec3 s = vec3(0);\ns += singleLight(p, n, si, sh, uLight[0]);\ns += singleLight(p, n, si, sh, uLight[1]);\ns += singleLight(p, n, si, sh, uLight[2]);\ns += singleLight(p, n, si, sh, uLight[3]);\nreturn s;\n}\n";
J3D.ShaderSource.Modifiers="//#name Modifiers\n//#description A collection of modifier functions for geometry (only bend for now)\nvec3 bend(vec3 ip, float ba, vec2 b, float o, float a) {\nvec3 op = ip;\nip.x = op.x * cos(a) - op.y * sin(a);\nip.y = op.x * sin(a) + op.y * cos(a);\nif(ba != 0.0) {\nfloat radius = b.y / ba;\nfloat onp = (ip.x - b.x) / b.y - o;\nip.z = cos(onp * ba) * radius - radius;\nip.x = (b.x + b.y * o) + sin(onp * ba) * radius;\n}\nop = ip;\nip.x = op.x * cos(-a) - op.y * sin(-a);\nip.y = op.x * sin(-a) + op.y * cos(-a);\nreturn ip;\n}\n";
J3D.ShaderSource.VertexInclude="//#name VertexInclude\n//#description Common attributes for a mesh - include this in a vertex shader so you don't rewrite this over and over again\nattribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;\nattribute vec2 aTextureCoord;\nattribute vec2 aTextureCoord2;\nattribute vec4 aVertexColor;\n";J3D.Ray=function(a,b){this.origin=a||new v3;this.direction=b||new v3;this.localOrigin=new v3;this.localDirection=new v3};J3D.Ray._mt=mat4.create();J3D.Ray._nt=mat3.create();J3D.Ray.fromMousePosition=function(a,b,c){a=[a/window.innerWidth*2-1,(1-b/window.innerHeight)*2-1,0];mat4.inverse(c.camera.projectionMat.toArray(),J3D.Ray._mt);mat4.multiplyVec3(J3D.Ray._mt,a);mat4.multiplyVec3(c.globalMatrix,a);b=new J3D.Ray;b.origin.fromArray(a);b.direction=b.origin.sub(c.worldPosition).norm();return b};
J3D.Ray.prototype.makeLocal=function(a){mat4.inverse(a.globalMatrix,J3D.Ray._mt);this.localOrigin.fromArray(mat4.multiplyVec3(J3D.Ray._mt,this.origin.xyz()));mat4.toInverseMat3(a.globalMatrix,J3D.Ray._nt);mat3.transpose(J3D.Ray._nt);a=this.direction;var b=this.direction.xyz(),c=J3D.Ray._nt;b[0]=a.x*c[0]+a.y*c[1]+a.z*c[2];b[1]=a.x*c[3]+a.y*c[4]+a.z*c[5];b[2]=a.x*c[6]+a.y*c[7]+a.z*c[8];this.localDirection.fromArray(b)};J3D.Collider=function(){this.center=v3.ZERO()};J3D.Collider.SPHERE=1;J3D.Collider.BOX=2;J3D.Collider.MESH=3;J3D.Collider.Sphere=function(a,b){var c=new J3D.Collider;c.type=J3D.Collider.SPHERE;c.radius=a||0;c.center=b||v3.ZERO();return c};J3D.Collider.Box=function(a){var b=new J3D.Collider;b.type=J3D.Collider.BOX;b.box=a;return b};J3D.Collider.Mesh=function(a){var b=new J3D.Collider;b.type=J3D.Collider.MESH;a.boundingBox||a.calculateBoundingBox();b.box=a.boundingBox;b.mesh=a;return b};J3D.Color=function(a,b,c,d){var e=this;this.r=a||0;this.g=b||0;this.b=c||0;this.a=d||0;this.rgba=function(){return[e.r,e.g,e.b,e.a]};this.rgb=function(){return[e.r,e.g,e.b]};this.toUniform=function(a){return a==gl.FLOAT_VEC3?this.rgb():this.rgba()}};J3D.Color.white=new J3D.Color(1,1,1,1);J3D.Color.black=new J3D.Color(0,0,0,1);J3D.Color.red=new J3D.Color(1,0,0,1);J3D.Color.green=new J3D.Color(0,1,0,1);J3D.Color.blue=new J3D.Color(0,0,1,1);J3D.Time={};J3D.Time.time=0;J3D.Time.startTime=0;J3D.Time.lastTime=0;J3D.Time.deltaTime=0;J3D.Time.tick=function(){var a=(new Date).getTime();if(J3D.Time.startTime==0)J3D.Time.startTime=a;if(J3D.Time.lastTime!=0)J3D.Time.deltaTime=a-J3D.Time.lastTime;J3D.Time.lastTime=a;J3D.Time.time=(a-J3D.Time.startTime)/1E3};J3D.Time.getTime=function(){J3D.Time.tick();return J3D.Time.deltaTime};
J3D.Time.formatTime=function(){var a=Math.floor(J3D.Time.time%1*100),b=Math.floor(J3D.Time.time)%60,c=Math.floor(J3D.Time.time/60);a<10&&(a="0"+a);a==100&&(a="00");b<10&&(b="0"+b);c<10&&(c="0"+c);return c+":"+b+":"+a};J3D.ParticleUtil={};J3D.ParticleUtil.insideCube=function(a,b,c){var d=new Float32Array(a*3);c=c||v3.ZERO();b/=2;for(var e=0;e<a*3;e+=3)d[e]=c.x+Math.random()*b*2-b+Math.random(),d[e+1]=c.y+Math.random()*b*2-b+Math.random(),d[e+2]=c.z+Math.random()*b*2-b+Math.random();return d};J3D.ParticleUtil.onSphere=function(a,b,c,d){var e=new Float32Array(a*3);d||v3.ZERO();c=c==null?1:c;for(d=0;d<a*3;d+=3){var f=v3.random().norm().mul(b+Math.random()*c);e[d]=f.x;e[d+1]=f.y;e[d+2]=f.z}return e};
J3D.ParticleUtil.randomColors=function(a,b,c){var d=new Float32Array(a*4);c=(c==null?1:c)-b;for(var e=0;e<a*4;e++)d[e]=b+Math.random()*c;return d};J3D.ShaderUtil={};J3D.ShaderUtil.setTexture=function(a,b,c,d){gl.activeTexture(33984+b);gl.bindTexture(gl.TEXTURE_2D,d);gl.uniform1i(a.uniforms[c].location,b)};J3D.ShaderUtil.setTextureCube=function(a,b,c,d){gl.activeTexture(33984+b);gl.bindTexture(gl.TEXTURE_CUBE_MAP,d);gl.uniform1i(a.uniforms[c].location,b)};
J3D.ShaderUtil.setAttributes=function(a,b){for(var c=0;c<b.arrays.length;c++){var d=b.arrays[c];a.attributes[d.name]!=null&&(gl.bindBuffer(gl.ARRAY_BUFFER,d.buffer),gl.vertexAttribPointer(a.attributes[d.name],d.itemSize,gl.FLOAT,!1,0,0))}};
J3D.ShaderUtil.setLights=function(a,b){for(var c=0;c<J3D.SHADER_MAX_LIGHTS;c++)b[c]&&a.uniforms["uLight["+c+"].type"]?(gl.uniform1i(a.uniforms["uLight["+c+"].type"].location,b[c].light.type),gl.uniform3fv(a.uniforms["uLight["+c+"].direction"].location,b[c].forward().xyz()),gl.uniform3fv(a.uniforms["uLight["+c+"].color"].location,b[c].light.color.rgb()),gl.uniform3fv(a.uniforms["uLight["+c+"].position"].location,b[c].worldPosition.xyz()),gl.uniform1f(a.uniforms["uLight["+c+"].intensity"].location,
b[c].light.intensity),gl.uniform1f(a.uniforms["uLight["+c+"].angleFalloff"].location,b[c].light.angleFalloff),gl.uniform1f(a.uniforms["uLight["+c+"].angle"].location,b[c].light.angle)):a.uniforms["uLight["+c+"].type"]&&gl.uniform1i(a.uniforms["uLight["+c+"].type"].location,J3D.NONE)};J3D.ShaderUtil.isTexture=function(a){return a==gl.SAMPLER_2D||a==gl.SAMPLER_CUBE};
J3D.ShaderUtil.getTypeName=function(a){switch(a){case gl.BYTE:return"BYTE (0x1400)";case gl.UNSIGNED_BYTE:return"UNSIGNED_BYTE (0x1401)";case gl.SHORT:return"SHORT (0x1402)";case gl.UNSIGNED_SHORT:return"UNSIGNED_SHORT (0x1403)";case gl.INT:return"INT (0x1404)";case gl.UNSIGNED_INT:return"UNSIGNED_INT (0x1405)";case gl.FLOAT:return"FLOAT (0x1406)";case gl.FLOAT_VEC2:return"FLOAT_VEC2 (0x8B50)";case gl.FLOAT_VEC3:return"FLOAT_VEC3 (0x8B51)";case gl.FLOAT_VEC4:return"FLOAT_VEC4 (0x8B52)";case gl.INT_VEC2:return"INT_VEC2   (0x8B53)";
case gl.INT_VEC3:return"INT_VEC3   (0x8B54)";case gl.INT_VEC4:return"INT_VEC4   (0x8B55)";case gl.BOOL:return"BOOL \t\t(0x8B56)";case gl.BOOL_VEC2:return"BOOL_VEC2  (0x8B57)";case gl.BOOL_VEC3:return"BOOL_VEC3  (0x8B58)";case gl.BOOL_VEC4:return"BOOL_VEC4  (0x8B59)";case gl.FLOAT_MAT2:return"FLOAT_MAT2 (0x8B5A)";case gl.FLOAT_MAT3:return"FLOAT_MAT3 (0x8B5B)";case gl.FLOAT_MAT4:return"FLOAT_MAT4 (0x8B5C)";case gl.SAMPLER_2D:return"SAMPLER_2D (0x8B5E)";case gl.SAMPLER_CUBE:return"SAMPLER_CUBE (0x8B60)";
default:return"Unknown ("+a.toString(16)+")"}};
J3D.ShaderUtil.setUniform=function(a,b,c){var d=b.uniforms[a];if(d)switch(c=c[a],c.toUniform&&(c=c.toUniform(d.type)),d.type){case gl.BYTE:gl.uniform1i(d.location,c);break;case gl.UNSIGNED_BYTE:gl.uniform1i(d.location,c);break;case gl.SHORT:gl.uniform1i(d.location,c);break;case gl.UNSIGNED_SHORT:gl.uniform1i(d.location,c);break;case gl.INT:gl.uniform1i(d.location,c);break;case gl.INT_VEC2:gl.uniform2iv(d.location,c);break;case gl.INT_VEC3:gl.uniform3iv(d.location,c);break;case gl.INT_VEC4:gl.uniform4iv(d.location,
c);break;case gl.UNSIGNED_INT:gl.uniform1i(d.location,c);break;case gl.FLOAT:gl.uniform1f(d.location,c);break;case gl.FLOAT_VEC2:gl.uniform2fv(d.location,c);break;case gl.FLOAT_VEC3:gl.uniform3fv(d.location,c);break;case gl.FLOAT_VEC4:gl.uniform4fv(d.location,c);break;case gl.BOOL:gl.uniform1i(d.location,c);break;case gl.BOOL_VEC2:gl.uniform2iv(d.location,c);break;case gl.BOOL_VEC3:gl.uniform3iv(d.location,c);break;case gl.BOOL_VEC4:gl.uniform4iv(d.location,c);break;case gl.FLOAT_MAT2:gl.uniformMatrix2fv(d.location,
!1,c);break;case gl.FLOAT_MAT3:gl.uniformMatrix3fv(d.location,!1,c);break;case gl.FLOAT_MAT4:gl.uniformMatrix4fv(d.location,!1,c);break;case gl.SAMPLER_2D:J3D.ShaderUtil.setTexture(b,d.texid,a,c);break;case gl.SAMPLER_CUBE:J3D.ShaderUtil.setTextureCube(b,d.texid,a,c);break;default:return"WARNING! Unknown uniform type ( 0x"+d.type.toString(16)+" )"}};
J3D.ShaderUtil.parseGLSL=function(a){a=a.split("\n");var b="",c="",d={};d.common="";d.includes=[];d.vertexIncludes=[];d.fragmentIncludes=[];for(var e=0,f=function(a,b){var c=b.indexOf(a);if(c>-1)return b.substring(c+a.length+1);return null},g=0;g<a.length;g++)if(a[g].indexOf("//#")>-1)if(a[g].indexOf("//#fragment")>-1)e++;else if(a[g].indexOf("//#vertex")>-1)e++;else{d.name=d.name||f("name",a[g]);var i=f("include",a[g]);if(i)switch(e){case 0:d.includes.push(i);break;case 1:d.vertexIncludes.push(i);
break;case 2:d.fragmentIncludes.push(i)}}else switch(i=a[g],i.indexOf("//")>-1&&(i=i.substring(0,i.indexOf("//"))),e){case 0:d.common+=i+"\n";break;case 1:b+=i+"\n";break;case 2:c+=i+"\n"}return new J3D.Shader(d.name||"Shader"+Math.round(Math.random()*1E3),b,c,d)};J3D.Intersection={};J3D.Intersection.rayTest=function(a,b){if(!b.collider)return j3dlog("Intersection test failed. "+b.name+" has no collider."),!1;switch(b.collider.type){case J3D.Collider.SPHERE:return J3D.Intersection.raySphere(a,b);case J3D.Collider.BOX:return J3D.Intersection.rayBox(a,b);case J3D.Collider.MESH:return J3D.Intersection.rayMesh(a,b);default:return j3dlog("Unrecognized collider type"),!1}};
J3D.Intersection.rayMesh=function(a,b){if(!b.collider.mesh||!b.collider.mesh.vertexPositionBuffer)return j3dlog("Intersection test failed. "+b.name+" has no mesh defined or no vertex data in the mesh."),!1;if(b.collider.box){if(!J3D.Intersection.rayBox(a,b))return!1}else a.makeLocal(b);for(var c=b.collider.mesh.vertexPositionBuffer.data,d=b.collider.mesh.elements.data,e=!1,f=0;f<d.length;f+=3){var g=d[f+0]*3,i=d[f+1]*3,h=d[f+2]*3;g=new v3(c[g],c[g+1],c[g+2]);i=new v3(c[i],c[i+1],c[i+2]);h=new v3(c[h],
c[h+1],c[h+2]);if(e=e||J3D.Intersection.rayTriangle(a,g,i,h))break}return e};
J3D.Intersection.rayTriangle=function(a,b,c,d){var e=v3.sub(b,c),f=v3.sub(b,d);f=v3.cross(f,e);var g=v3.dot(f,a.localDirection);if(!(g<0))return!1;e=v3.dot(f,b)-v3.dot(f,a.localOrigin);if(!(e<=0))return!1;e/=g;var i=a.localDirection.norm().mul(e);i=v3.add(i,a.localOrigin);Math.abs(f.x)>Math.abs(f.y)?Math.abs(f.x)>Math.abs(f.z)?(a=i.y-b.y,f=c.y-b.y,g=d.y-b.y,i=i.z-b.z,c=c.z-b.z,d=d.z-b.z):(a=i.x-b.x,f=c.x-b.x,g=d.x-b.x,i=i.y-b.y,c=c.y-b.y,d=d.y-b.y):Math.abs(f.y)>Math.abs(f.z)?(a=i.x-b.x,f=c.x-b.x,
g=d.x-b.x,i=i.z-b.z,c=c.z-b.z,d=d.z-b.z):(a=i.x-b.x,f=c.x-b.x,g=d.x-b.x,i=i.y-b.y,c=c.y-b.y,d=d.y-b.y);b=f*d-c*g;if(b==0)return!1;b=1/b;d=(a*d-i*g)*b;if(!(d>=0))return!1;b*=f*i-c*a;if(!(b>=0))return!1;if(!(1-d-b>=0))return!1;return e};
J3D.Intersection.raySphere=function(a,b){if(!b.collider.radius)return j3dlog("Intersection test failed. "+b.name+" has no radius defined."),!1;var c=b.collider.radius;c*=c;a.makeLocal(b);var d=b.collider.center.sub(a.localOrigin);if(d.lengthSq<c)return!1;var e=v3.dot(d,a.localDirection);if(e<=0)return!1;b=c-(d.magSq()-e*e);if(b>=0)return Math.abs(e)-Math.sqrt(b);return!1};
J3D.Intersection.rayBox=function(a,b){if(!b.collider.box)return j3dlog("Intersection test failed. "+b.name+" has no box defined."),!1;var c=b.collider.box;a.makeLocal(b);var d=0,e=0,f=0,g=!0;a.localOrigin.x<c.minX?(d=c.minX-a.localOrigin.x,d/=a.localDirection.x,g=!1):a.localOrigin.x>c.maxX&&(d=c.maxX-a.localOrigin.x,d/=a.localDirection.x,g=!1);a.localOrigin.y<c.minY?(e=c.minY-a.localOrigin.y,e/=a.localDirection.y,g=!1):a.localOrigin.y>c.maxY&&(e=c.maxY-a.localOrigin.y,e/=a.localDirection.y,g=!1);
a.localOrigin.z<c.minZ?(f=c.minZ-a.localOrigin.z,f/=a.localDirection.z,g=!1):a.localOrigin.z>c.maxZ&&(f=c.maxZ-a.localOrigin.z,f/=a.localDirection.z,g=!1);if(g)return-1;g=0;e>d&&(g=1,d=e);f>d&&(g=2,d=f);switch(g){case 0:e=a.localOrigin.y+a.localDirection.y*d;if(e<c.minY||e>c.maxY)return!1;e=a.localOrigin.z+a.localDirection.z*d;if(e<c.minZ||e>c.maxZ)return!1;break;case 1:e=a.localOrigin.x+a.localDirection.x*d;if(e<c.minX||e>c.maxX)return!1;e=a.localOrigin.z+a.localDirection.z*d;if(e<c.minZ||e>c.maxZ)return!1;
break;case 2:e=a.localOrigin.x+a.localDirection.x*d;if(e<c.minX||e>c.maxX)return!1;e=a.localOrigin.y+a.localDirection.y*d;if(e<c.minY||e>c.maxY)return!1}return d};J3D.BuiltinShaders=function(){var a={},b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Phong);b.su.color=J3D.Color.white;b.hasColorTexture=!1;a.Phong=b;b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Gouraud);b.su.color=J3D.Color.white;b.hasColorTexture=!1;a.Gouraud=b;b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Lightmap);b.setup=function(a,b){for(var e in a.uniforms)e=="lightmapTexture"?J3D.ShaderUtil.setTexture(a,1,"lightmapTexture",J3D.LightmapAtlas[b.lightmapIndex].tex):e=="lightmapAtlas"&&gl.uniform4fv(a.uniforms.lightmapAtlas.location,
b.lightmapTileOffset);J3D.Shader.prototype.setup.call(this,a,b)};a.Lightmap=b;a.Toon=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Toon);a.Reflective=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Reflective);a.Skybox=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Skybox);a.Normal2Color=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Normal2Color);a.Selflit=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Selflit);return{shaders:a,fetch:function(b){return a[b]?a[b].clone():(j3dlog("ERROR. Built-in shader "+b+" doesn't exist"),
null)}}}();if(!window.requestAnimationFrame)window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();
